{% extends "base.html" %}
{% block title %}Dashboard - SecureTech AV CRM{% endblock %}

{% block main %}
<main class="main-container p-4">
  <div class="flex items-center gap-2 text-xs text-gray-500 mb-3">
    <a href="/dashboard/" class="hover:text-blue-600 cursor-pointer">Home</a> /
    <span class="text-gray-900">Dashboard</span>
  </div>

  <h1 class="text-xl font-bold mb-4">Dashboard Overview</h1>
<!-- === Filter Bar === -->
<form method="get" class="bg-white p-4 mb-4 rounded-lg shadow-sm border border-gray-100 flex flex-wrap gap-3 items-center">
  <select name="lead" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
    <option value="">All Leads</option>
    {% for lead in all_leads %}
      <option value="{{ lead.id }}" {% if lead.id|stringformat:"s" == lead_filter %}selected{% endif %}>
        {{ lead.first_name }} {{ lead.last_name }}
      </option>
    {% endfor %}
  </select>

  <select name="city" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
    <option value="">All Cities</option>
    {% for city in all_cities %}
      <option value="{{ city }}" {% if city == city_filter %}selected{% endif %}>{{ city }}</option>
    {% endfor %}
  </select>

  <select name="status" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
    <option value="">All Statuses</option>
    {% for status in all_statuses %}
      <option value="{{ status }}" {% if status == status_filter %}selected{% endif %}>{{ status|title }}</option>
    {% endfor %}
  </select>

  <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">
    <i class="fa-solid fa-filter"></i> Apply
  </button>
  <a href="{% url 'dashboard' %}" class="px-3 py-2 bg-gray-100 rounded-lg text-sm text-gray-700 hover:bg-gray-200">
    Reset
  </a>
</form>

  <div class="grid grid-cols-12 gap-4 h-[calc(100vh-180px)]">

    <!-- Left Column -->
    <div class="col-span-12 lg:col-span-3 flex flex-col gap-4">
      <div class="grid grid-cols-2 gap-3">
        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-3">
          <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center text-blue-600 mb-2">
            <i class="fa-solid fa-indian-rupee-sign text-sm"></i>
          </div>
          <p class="text-xs text-gray-500 mb-0.5">Total Billing</p>
          <p class="text-lg font-bold">₹{{ total_billing|floatformat:0|default:"0" }}</p>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-3">
          <div class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center text-purple-600 mb-2">
            <i class="fa-solid fa-percent text-sm"></i>
          </div>
          <p class="text-xs text-gray-500 mb-0.5">Conversion</p>
          <p class="text-lg font-bold">{{ conversion_rate }}%</p>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-3">
          <div class="w-8 h-8 rounded-lg bg-teal-100 flex items-center justify-center text-teal-600 mb-2">
            <i class="fa-solid fa-scale-balanced text-sm"></i>
          </div>
          <p class="text-xs text-gray-500 mb-0.5">Avg. Deal</p>
          <p class="text-lg font-bold">₹{{ avg_deal|floatformat:0|default:"0" }}</p>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-3">
          <div class="w-8 h-8 rounded-lg bg-pink-100 flex items-center justify-center text-pink-600 mb-2">
            <i class="fa-solid fa-trophy text-sm"></i>
          </div>
          <p class="text-xs text-gray-500 mb-0.5">Win Rate</p>
          <p class="text-lg font-bold">{{ win_rate }}%</p>
        </div>
      </div>
<!-- === Project Distribution (by Lead Source) === -->
<div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 flex-1 min-h-[260px]">
  <h2 class="text-sm font-semibold mb-3 flex items-center gap-2">
    <i class="fa-solid fa-chart-bar text-teal-600 text-xs"></i> Project Distribution (by Lead Source)
  </h2>
  <div class="relative h-56 flex justify-center items-center">
    <canvas id="leadBarChart"></canvas>
  </div>
</div>

      <!-- Leads Distribution -->
      <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 flex-1">
        <h2 class="text-sm font-semibold mb-3 flex items-center gap-2">
          <i class="fa-solid fa-users text-blue-600 text-xs"></i> Projects Distribution
        </h2>

        <div class="flex items-center gap-3">
          <div class="flex-1 space-y-2">
            {% for status, count in status_counts.items %}
              {% if count > 0 %}
                <div class="flex justify-between items-center">
                  <div class="flex items-center gap-1.5">
                    <div class="w-2 h-2 rounded-full 
                      {% if status == 'Won' %}bg-green-500
                      {% elif status == 'Advanced' %}bg-yellow-500
                      {% elif status == 'BOQ' %}bg-purple-500
                      {% elif status == 'Contacted' %}bg-indigo-500
                      {% elif status == 'New' %}bg-blue-500
                      {% else %}bg-orange-500
                      {% endif %}"></div>
                    <span class="text-xs">{{ status }}</span>
                  </div>
                  <span class="font-bold text-xs">{{ count }}</span>
                </div>
              {% endif %}
            {% endfor %}
          </div>

          <div class="w-28 h-28 flex-shrink-0">
            <canvas id="statusPieChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Middle Column -->
    <div class="col-span-12 lg:col-span-5 bg-white p-4 rounded-lg shadow-sm border border-gray-100 overflow-hidden flex flex-col">
      <h2 class="text-sm font-semibold mb-3 flex items-center gap-2">
        <i class="fa-solid fa-star text-yellow-500 text-xs"></i> Top Projects by Value
      </h2>
      <div class="overflow-auto flex-1">
        <table class="w-full text-xs">
          <thead class="bg-gray-50 sticky top-0">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Lead Name</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">City</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Value</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Status</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Date</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            {% if top_leads %}
              {% for project in top_leads %}
                <tr class="hover:bg-gray-50">
                  <td class="px-3 py-2 font-medium">{{ project.lead_source.first_name }} {{ project.lead_source.last_name }}</td>
                  <td class="px-3 py-2 text-gray-600">{{ project.lead_source.city|default:"N/A" }}</td>
                  <td class="px-3 py-2 font-semibold">₹{{ project.amount|floatformat:0 }}</td>
                  <td class="px-3 py-2">
                    <span class="status-badge 
                      {% if project.status == 'won' %}bg-green-100 text-green-700
                      {% elif project.status == 'advanced' %}bg-purple-100 text-purple-700
                      {% elif project.status == 'boq' %}bg-yellow-100 text-yellow-700
                      {% elif project.status == 'contacted' %}bg-indigo-100 text-indigo-700
                      {% else %}bg-blue-100 text-blue-700
                      {% endif %}">
                      {{ project.status|title }}
                    </span>
                  </td>
                  <td class="px-3 py-2 text-gray-500">{{ project.snapshot_d|timesince }} ago</td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="5" class="px-3 py-8 text-center text-gray-500">
                  <i class="fa-solid fa-inbox text-3xl mb-2 block text-gray-300"></i>
                  No projects yet
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Right Column -->
    <div class="col-span-12 lg:col-span-4 bg-white p-4 rounded-lg shadow-sm border border-gray-100 flex flex-col">
      <h2 class="text-sm font-semibold mb-3 flex items-center gap-2">
        <i class="fa-solid fa-chart-line text-blue-600 text-xs"></i> Revenue Trend (Last 12 Months)
      </h2>
      <div class="flex-1">
        <canvas id="revenueBarChart"></canvas>
      </div>
      <p class="text-xs text-center text-gray-500 mt-2">created by <span class="font-semibold text-blue-600">crest media tech</span></p>
    </div>
  </div>
</main>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // === STATUS DISTRIBUTION PIE CHART ===
  const statusData = {{ status_counts|safe }};
  const pieLabels = Object.keys(statusData).filter(k => statusData[k] > 0);
  const pieData = pieLabels.map(k => statusData[k]);

  const colorMap = {
    'won': '#10B981',
    'advanced': '#F59E0B',
    'boq': '#8B5CF6',
    'contacted': '#6366F1',
    'new': '#3B82F6',
    'closed': '#9CA3AF',
    'lost': '#EF4444'
  };
  const pieColors = pieLabels.map(label => colorMap[label.toLowerCase()] || '#94A3B8');

  if (pieLabels.length > 0) {
    new Chart(document.getElementById('statusPieChart'), {
      type: 'doughnut',
      data: {
        labels: pieLabels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
        datasets: [{
          data: pieData,
          backgroundColor: pieColors,
          borderColor: '#fff',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '65%',
        plugins: {
          legend: {
            display: true,
            position: 'bottom',
            labels: { boxWidth: 12, color: '#374151', font: { size: 11 } }
          }
        }
      }
    });
  }

 // === PROJECT DISTRIBUTION BAR CHART (BY LEAD SOURCE) ===
const leadSourceData = JSON.parse('{{ lead_source_counts|escapejs }}');
const leadLabels = Object.keys(leadSourceData);
const leadData = Object.values(leadSourceData);
const leadColors = ['#3B82F6', '#10B981', '#F59E0B', '#8B5CF6', '#EF4444', '#6366F1', '#14B8A6', '#F472B6'];

if (leadLabels.length > 0) {
  new Chart(document.getElementById('leadBarChart'), {
    type: 'bar',
    data: {
      labels: leadLabels,
      datasets: [{
        label: 'Projects',
        data: leadData,
        backgroundColor: leadColors.slice(0, leadLabels.length),
        borderRadius: 4,
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => `${ctx.dataset.label}: ${ctx.raw}`
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { color: '#6B7280', font: { size: 11 } }
        },
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1, color: '#6B7280', font: { size: 11 } },
          grid: { color: '#E5E7EB' }
        }
      }
    }
  });
}


  // === REVENUE CHART ===
  const months = {{ revenue_labels|safe }};
  const revenueData = {{ revenue_data|safe }};
  new Chart(document.getElementById('revenueBarChart'), {
    type: 'bar',
    data: {
      labels: months,
      datasets: [{
        label: 'Revenue',
        data: revenueData,
        backgroundColor: '#3B82F6',
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1F2937',
          callbacks: { label: ctx => `₹${ctx.raw.toLocaleString()}` }
        }
      },
      scales: {
        x: { grid: { display: false }, ticks: { color: '#6B7280', font: { size: 10 } } },
        y: { grid: { display: false }, beginAtZero: true, ticks: { color: '#6B7280', font: { size: 10 } } }
      }
    }
  });
</script>

{% endblock %}
