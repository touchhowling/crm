{% extends "base.html" %}
{% block title %}Dashboard - SecureTech AV CRM{% endblock %}

{% block main %}
<main class="main-container p-4">
  <!-- Breadcrumb -->
  <div class="flex items-center gap-2 text-xs text-gray-500 mb-3">
    <a href="/dashboard/" class="hover:text-blue-600 cursor-pointer">Home</a> /
    <span class="text-gray-900">Dashboard</span>
  </div>

  <h1 class="text-xl font-bold mb-4">Dashboard Overview</h1>

  <!-- Filter Bar -->
  <form method="get" class="bg-white p-4 mb-4 rounded-lg shadow-sm border border-gray-100">
    <div class="flex flex-wrap gap-3 items-center">
      <select name="lead" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
        <option value="">All Leads</option>
        {% for lead in all_leads %}
          <option value="{{ lead.id }}" {% if lead.id|stringformat:"s" == lead_filter %}selected{% endif %}>
            {{ lead.first_name }} {{ lead.last_name }}
          </option>
        {% endfor %}
      </select>

      <select name="city" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
        <option value="">All Cities</option>
        {% for city in all_cities %}
          <option value="{{ city }}" {% if city == city_filter %}selected{% endif %}>{{ city }}</option>
        {% endfor %}
      </select>

      <select name="status" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
        <option value="">All Statuses</option>
        {% for status in all_statuses %}
          <option value="{{ status }}" {% if status == status_filter %}selected{% endif %}>{{ status|title }}</option>
        {% endfor %}
      </select>

      <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition">
        <i class="fa-solid fa-filter"></i> Apply
      </button>
      <a href="{% url 'dashboard' %}" class="px-3 py-2 bg-gray-100 rounded-lg text-sm text-gray-700 hover:bg-gray-200 transition">
        <i class="fa-solid fa-rotate-right"></i> Reset
      </a>
    </div>
  </form>

  <!-- KPI Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <!-- Total Billing -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 hover:shadow-md transition">
      <div class="flex items-start justify-between mb-3">
        <div class="w-12 h-12 rounded-lg bg-blue-100 flex items-center justify-center text-blue-600">
          <i class="fa-solid fa-indian-rupee-sign text-lg"></i>
        </div>
      </div>
      <p class="text-xs font-medium text-gray-500 mb-1 uppercase tracking-wide">Total Billing</p>
      <p class="text-2xl font-bold text-gray-900">₹{{ total_billing|floatformat:0|default:"0" }}</p>
    </div>

    <!-- Conversion Rate -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 hover:shadow-md transition">
      <div class="flex items-start justify-between mb-3">
        <div class="w-12 h-12 rounded-lg bg-purple-100 flex items-center justify-center text-purple-600">
          <i class="fa-solid fa-percent text-lg"></i>
        </div>
      </div>
      <p class="text-xs font-medium text-gray-500 mb-1 uppercase tracking-wide">Conversion Rate</p>
      <p class="text-2xl font-bold text-gray-900">{{ conversion_rate }}%</p>
    </div>

    <!-- Avg Deal Size -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 hover:shadow-md transition">
      <div class="flex items-start justify-between mb-3">
        <div class="w-12 h-12 rounded-lg bg-teal-100 flex items-center justify-center text-teal-600">
          <i class="fa-solid fa-scale-balanced text-lg"></i>
        </div>
      </div>
      <p class="text-xs font-medium text-gray-500 mb-1 uppercase tracking-wide">Avg. Deal Size</p>
      <p class="text-2xl font-bold text-gray-900">₹{{ avg_deal|floatformat:0|default:"0" }}</p>
    </div>

    <!-- Win Rate -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 hover:shadow-md transition">
      <div class="flex items-start justify-between mb-3">
        <div class="w-12 h-12 rounded-lg bg-pink-100 flex items-center justify-center text-pink-600">
          <i class="fa-solid fa-trophy text-lg"></i>
        </div>
      </div>
      <p class="text-xs font-medium text-gray-500 mb-1 uppercase tracking-wide">Win Rate</p>
      <p class="text-2xl font-bold text-gray-900">{{ win_rate }}%</p>
    </div>
  </div>

  <!-- Main Dashboard Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
    
    <!-- LEFT COLUMN - Charts & Analytics -->
    <div class="lg:col-span-4 space-y-4">
      
      <!-- Project Status Distribution -->
      <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
        <h2 class="text-sm font-bold mb-4 flex items-center gap-2 text-gray-800">
          <i class="fa-solid fa-chart-pie text-blue-600"></i> 
          Project Status Distribution
        </h2>
        
        <div class="flex flex-col gap-4">
          <!-- Chart Container -->
          <div class="flex justify-center">
            <div class="w-48 h-48">
              <canvas id="statusPieChart"></canvas>
            </div>
          </div>
          
          <!-- Dynamic Legend (Auto-generated by JavaScript) -->
          <div class="pt-3 border-t border-gray-100">
            <div class="grid grid-cols-2 gap-2" id="statusLegend">
              <!-- This will be populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>

      <!-- Projects by Lead Source -->
      <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
        <h2 class="text-sm font-bold mb-4 flex items-center gap-2 text-gray-800">
          <i class="fa-solid fa-chart-bar text-teal-600"></i> 
          Projects by Lead Source
        </h2>
        <div class="h-64">
          <canvas id="leadBarChart"></canvas>
        </div>
      </div>
    </div>

    <!-- MIDDLE COLUMN - Top Projects Table & Top Selling Items -->
    <div class="lg:col-span-5 space-y-4">
      
      <!-- Top Projects by Value -->
      <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
        <h2 class="text-sm font-bold mb-4 flex items-center gap-2 text-gray-800">
          <i class="fa-solid fa-star text-yellow-500"></i> 
          Top Projects by Value
        </h2>
        <div class="overflow-auto" style="max-height: calc(100vh - 500px);">
          <table class="w-full text-xs">
            <thead class="bg-gray-50 sticky top-0">
              <tr class="border-b border-gray-200">
                <th class="px-4 py-3 text-left font-semibold text-gray-700 uppercase tracking-wide">Project</th>
                <th class="px-4 py-3 text-left font-semibold text-gray-700 uppercase tracking-wide">Lead</th>
                <th class="px-4 py-3 text-left font-semibold text-gray-700 uppercase tracking-wide">City</th>
                <th class="px-4 py-3 text-left font-semibold text-gray-700 uppercase tracking-wide">Value</th>
                <th class="px-4 py-3 text-left font-semibold text-gray-700 uppercase tracking-wide">Status</th>
                <th class="px-4 py-3 text-left font-semibold text-gray-700 uppercase tracking-wide">Date</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              {% if top_leads %}
                {% for project in top_leads %}
                  <tr class="hover:bg-blue-50 transition">
                    <td class="px-4 py-3 font-medium text-gray-900">
                      {{ project.project_name|truncatewords:5 }}
                    </td>
                    <td class="px-4 py-3 text-gray-700">
                      {{ project.lead_source.first_name }} {{ project.lead_source.last_name }}
                    </td>
                    <td class="px-4 py-3 text-gray-600">{{ project.lead_source.city|default:"N/A" }}</td>
                    <td class="px-4 py-3 font-bold text-blue-600">₹{{ project.amount|floatformat:0 }}</td>
                    <td class="px-4 py-3">
                      <span class="px-2.5 py-1 rounded-full text-xs font-semibold
                        {% if project.status == 'won' %}bg-green-100 text-green-700
                        {% elif project.status == 'advanced' %}bg-purple-100 text-purple-700
                        {% elif project.status == 'boq' %}bg-yellow-100 text-yellow-700
                        {% elif project.status == 'contacted' %}bg-indigo-100 text-indigo-700
                        {% else %}bg-blue-100 text-blue-700
                        {% endif %}">
                        {{ project.status|title }}
                      </span>
                    </td>
                    <td class="px-4 py-3 text-gray-500">{{ project.snapshot_d|date:"M d, Y" }}</td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="6" class="px-4 py-12 text-center">
                    <i class="fa-solid fa-inbox text-5xl text-gray-300 mb-3 block"></i>
                    <p class="text-sm text-gray-500">No projects yet</p>
                  </td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Top Selling Inventory -->
      <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
        <h2 class="text-sm font-bold mb-4 flex items-center gap-2 text-gray-800">
          <i class="fa-solid fa-box text-orange-600"></i> 
          Top Selling Items
        </h2>
        <div class="space-y-2 max-h-80 overflow-y-auto">
          {% if top_inventory %}
            {% for item in top_inventory %}
              <div class="flex justify-between items-center p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition">
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-gray-900 truncate">{{ item.item_name }}</p>
                  <p class="text-xs text-gray-500 mt-0.5">Quantity Sold: {{ item.total_sold }}</p>
                </div>
                <span class="text-sm font-bold text-blue-600 ml-3">₹{{ item.total_revenue|floatformat:0 }}</span>
              </div>
            {% endfor %}
          {% else %}
            <div class="text-center py-8">
              <i class="fa-solid fa-inbox text-4xl text-gray-300 mb-2"></i>
              <p class="text-sm text-gray-500">No sales data yet</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN - Revenue & City Charts -->
    <div class="lg:col-span-3 space-y-4">
      
      <!-- Revenue Trend -->
      <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
        <h2 class="text-sm font-bold mb-4 flex items-center gap-2 text-gray-800">
          <i class="fa-solid fa-chart-line text-blue-600"></i> 
          Revenue Trend (12 Months)
        </h2>
        <div class="h-72">
          <canvas id="revenueChart"></canvas>
        </div>
      </div>

      <!-- City-wise Sales -->
      <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-100">
        <h2 class="text-sm font-bold mb-4 flex items-center gap-2 text-gray-800">
          <i class="fa-solid fa-map-location-dot text-green-600"></i> 
          City-wise Sales
        </h2>
        <div class="h-64">
          <canvas id="cityChart"></canvas>
        </div>
        <!-- Dynamic City Legend -->
        <div class="mt-4 pt-3 border-t border-gray-100 max-h-32 overflow-y-auto">
          <div class="grid grid-cols-1 gap-1.5 text-xs" id="cityLegend">
            <!-- This will be populated by JavaScript -->
          </div>
        </div>
      </div>

     

  </div>
</main>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  
  const colorPalette = {
    blue: '#3B82F6',
    green: '#10B981',
    yellow: '#EAB308',
    purple: '#8B5CF6',
    red: '#EF4444',
    indigo: '#6366F1',
    teal: '#14B8A6',
    pink: '#F472B6',
    orange: '#F97316',
    gray: '#6B7280'
  };

  // === PROJECT STATUS PIE CHART ===
  const statusData = {{ status_counts|safe }};
  const pieLabels = Object.keys(statusData).filter(k => statusData[k] > 0);
  const pieData = pieLabels.map(k => statusData[k]);
  
  const statusColorMap = {
    'Won': '#10B981',
    'Advanced': '#EAB308',
    'BOQ': '#8B5CF6',
    'Contacted': '#6366F1',
    'New': '#3B82F6',
    'In Progress': '#14B8A6',
    'Testing': '#F97316',
    'Closed': '#6B7280',
    'Lost': '#EF4444',
  };

  const pieColors = pieLabels.map(label => statusColorMap[label] || '#EC4899');

  if (pieLabels.length > 0) {
    new Chart(document.getElementById('statusPieChart'), {
      type: 'doughnut',
      data: {
        labels: pieLabels,
        datasets: [{
          data: pieData,
          backgroundColor: pieColors,
          borderWidth: 3,
          borderColor: '#fff',
          hoverOffset: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        cutout: '60%',
        plugins: {
          legend: { 
            display: false
          },
          tooltip: {
            backgroundColor: '#1F2937',
            padding: 12,
            titleFont: { size: 13, weight: 'bold' },
            bodyFont: { size: 12 },
            cornerRadius: 6,
            callbacks: {
              label: (ctx) => `${ctx.label}: ${ctx.raw} project${ctx.raw > 1 ? 's' : ''}`
            }
          }
        }
      }
    });

    // Create dynamic legend for status pie chart
    const statusLegendHTML = pieLabels.map((status, idx) => `
      <div class="flex items-center gap-2">
        <div class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: ${pieColors[idx]}"></div>
        <span class="text-xs text-gray-700">${status}</span>
        <span class="text-xs font-bold text-gray-900 ml-auto">${pieData[idx]}</span>
      </div>
    `).join('');
    
    document.getElementById('statusLegend').innerHTML = statusLegendHTML;
  }

  // === PROJECTS BY LEAD SOURCE BAR CHART ===
  const leadSourceData = JSON.parse('{{ lead_source_counts|escapejs }}');
  const leadLabels = Object.keys(leadSourceData).slice(0, 8);
  const leadData = Object.values(leadSourceData).slice(0, 8);
  const leadColors = [
    colorPalette.blue, colorPalette.green, colorPalette.yellow, 
    colorPalette.purple, colorPalette.red, colorPalette.indigo, 
    colorPalette.teal, colorPalette.pink
  ];

  if (leadLabels.length > 0) {
    new Chart(document.getElementById('leadBarChart'), {
      type: 'bar',
      data: {
        labels: leadLabels,
        datasets: [{
          label: 'Projects',
          data: leadData,
          backgroundColor: leadColors.slice(0, leadLabels.length),
          borderRadius: 6,
          barThickness: 30
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#1F2937',
            padding: 12,
            cornerRadius: 6,
            callbacks: {
              label: (ctx) => `Projects: ${ctx.raw}`
            }
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { 
              color: '#6B7280', 
              font: { size: 10, weight: '500' },
              maxRotation: 45,
              minRotation: 45
            }
          },
          y: {
            beginAtZero: true,
            ticks: { 
              stepSize: 1, 
              color: '#6B7280', 
              font: { size: 10 } 
            },
            grid: { color: '#E5E7EB' }
          }
        }
      }
    });
  }

  // === REVENUE TREND CHART ===
  const months = {{ revenue_labels|safe }};
  const revenueData = {{ revenue_data|safe }};
  
  new Chart(document.getElementById('revenueChart'), {
    type: 'bar',
    data: {
      labels: months,
      datasets: [{
        label: 'Revenue',
        data: revenueData,
        backgroundColor: colorPalette.blue,
        borderRadius: 6,
        barThickness: 16
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1F2937',
          padding: 12,
          cornerRadius: 6,
          callbacks: { 
            label: (ctx) => `₹${ctx.raw.toLocaleString()}` 
          }
        }
      },
      scales: {
        x: { 
          grid: { color: '#E5E7EB' },
          ticks: { 
            color: '#6B7280', 
            font: { size: 10 },
            callback: function(value) {
              return '₹' + (value/1000).toFixed(0) + 'K';
            }
          }
        },
        y: { 
          grid: { display: false },
          ticks: { 
            color: '#6B7280', 
            font: { size: 10, weight: '500' } 
          }
        }
      }
    }
  });

  // === CITY-WISE SALES CHART ===
  const cityData = JSON.parse('{{ city_counts|escapejs }}');
  const cityLabels = Object.keys(cityData).slice(0, 10);
  const cityCounts = Object.values(cityData).slice(0, 10);
  const cityColors = [
    colorPalette.green, colorPalette.teal, colorPalette.blue,
    colorPalette.purple, colorPalette.pink, colorPalette.yellow,
    colorPalette.indigo, colorPalette.red, '#94A3B8', '#64748B'
  ];

  if (cityLabels.length > 0) {
    new Chart(document.getElementById('cityChart'), {
      type: 'doughnut',
      data: {
        labels: cityLabels,
        datasets: [{
          data: cityCounts,
          backgroundColor: cityColors.slice(0, cityLabels.length),
          borderWidth: 3,
          borderColor: '#fff',
          hoverOffset: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '55%',
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: '#1F2937',
            padding: 12,
            cornerRadius: 6,
            callbacks: {
              label: (ctx) => `${ctx.label}: ${ctx.raw} projects`
            }
          }
        }
      }
    });

    // Create dynamic legend for city chart
    const cityLegendHTML = cityLabels.map((city, idx) => `
      <div class="flex items-center gap-2 py-1">
        <div class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: ${cityColors[idx]}"></div>
        <span class="text-gray-700 flex-1 truncate">${city}</span>
        <span class="font-semibold text-gray-900">${cityCounts[idx]}</span>
      </div>
    `).join('');
    
    document.getElementById('cityLegend').innerHTML = cityLegendHTML;
  }
</script>
{% endblock %}