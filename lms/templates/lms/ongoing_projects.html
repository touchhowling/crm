{% extends "base.html" %}
{% block title %}Leads - SecureTech AV CRM{% endblock %}

{%block main %}
<main class="p-8">
  <div class="flex items-center gap-2 text-sm text-gray-500 mb-6">
    <a href="/dashboard/" class="hover:text-teal-600 cursor-pointer">Home</a> /
    <span class="text-gray-900">Leads</span>
  </div>

  <div class="flex justify-between items-center mb-8">
    <h1 class="text-3xl font-bold">Ongoing Projects</h1>
    <div class="flex items-center gap-3">
      <span class="text-sm text-gray-500">Ongoing Projects</span>
      <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-teal-100 text-teal-700">
        Live
      </span>
    </div>
  </div>
  <!-- Filter Bar + Export Button -->
  <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6 flex flex-wrap gap-3 items-center">
    <select id="filterCity"
      class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
      <option value="">All Cities</option>
    </select>

    <select id="filterStatus"
      class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-teal-500">
      <option value="">All Statuses</option>
      <option value="open">Open</option>
      <option value="contacted">Contacted</option>
      <option value="boq">BOQ</option>
      <option value="advance">Advance</option>
      <option value="won">Won</option>
      <option value="lost">Lost</option>
    </select>

    <div class="ml-auto flex gap-2">
      <button id="exportBtn"
        class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 flex items-center gap-2">
        Export to Excel
      </button>

    </div>
  </div>
  {% load humanize %}

  <!-- Projects Table -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="overflow-x-auto responsive-table">
      <table id="projectsTable" class="w-full text-sm text-left">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
          <tr>
            <th class="px-6 py-4 sortable" data-sort="project_name">Project Name</th>
            <th class="px-6 py-4 sortable" data-sort="lead_source">Lead Source</th>
            <th class="px-6 py-4 sortable" data-sort="city">City</th>
            <th class="px-6 py-4 sortable" data-sort="amount">Amount</th>
            <th class="px-6 py-4 sortable" data-sort="expected_closure">Expected Closure</th>
            <th class="px-6 py-4 sortable" data-sort="status">Status</th>
            <th class="px-6 py-4 sortable" data-sort="actions" text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for project in projects %}
          <tr class="border-b hover:bg-gray-50 transition" data-city="{{ project.city|default:'' }}">
            <td class="px-6 py-3 font-medium">{{ project.project_name }}</td>
            <td class="px-6 py-3">{{ project.lead_source.first_name }} {{ project.lead_source.last_name }}</td>
            <td class="px-6 py-3">
              {{ project.city|default:"—" }}
            </td>
            <td class="px-6 py-3">
              <div class="flex items-center gap-2">
                <span id="amount-display-{{ project.id }}">₹{{ project.amount|intcomma }}</span>
                <button onclick="editAmount({{ project.id }} , '{{ project.amount }}')"
                  class="text-blue-500 hover:text-blue-700 text-sm">
                  <i class="fa-solid fa-pencil"></i>
                </button>
              </div>
              <div id="amount-edit-{{ project.id }}" class="hidden">
                <div class="flex items-center gap-2">
                  <input type="number" id="amount-input-{{ project.id }}" step="0.01"
                    class="w-32 px-2 py-1 border rounded text-sm" value="{{ project.amount }}">
                  <button onclick="saveAmount({{ project.id }})" class="text-green-600 hover:text-green-800">
                    <i class="fa-solid fa-check"></i>
                  </button>
                  <button onclick="cancelEdit({{ project.id }})" class="text-red-600 hover:text-red-800">
                    <i class="fa-solid fa-times"></i>
                  </button>
                </div>
              </div>
            </td>
            <td class="px-6 py-3">{{ project.expected_closure|date:"M d, Y" }}</td>
            <td class="px-6 py-3">
              <span class="px-2 py-1 rounded-full text-xs font-semibold 
                  {% if project.status == 'won' %}bg-green-100 text-green-700
                  {% elif project.status == 'lost' %}bg-red-100 text-red-700
                  {% else %}bg-yellow-100 text-yellow-700{% endif %}">
                {{ project.status }}
              </span>
            </td>
            <td class="px-6 py-3 text-center">
              <a href="{% url 'project_boq_detail' project.id %}" class="text-blue-500 hover:text-blue-700">
                <i class="fa-solid fa-pen"></i>
              </a>
              <a href="{% url 'delete_project' project.id %}" onclick="return confirm('Delete this project?')"
                class="text-red-500 hover:text-red-700 ml-2">
                <i class="fa-solid fa-trash"></i>
              </a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="text-center text-gray-500 py-4">No projects found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

    </div>
    <div class="px-6 py-4 border-t border-gray-200 text-center text-sm text-gray-500">
      Showing <span id="projectCount">{{ projects|length }}</span> projects
    </div>

  </div>
</main>

<footer class="px-6 py-4 border-t border-gray-200 bg-white text-center text-xs text-gray-500">
  <p>created by <span class="font-semibold text-teal-600">crest media tech</span></p>
</footer>
</div>

<!-- Add Project Modal -->
<div id="addProjectModal" class="modal">
  <div class="modal-content">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
          <i class="fa-solid fa-folder-plus text-green-500"></i>
          Add New Project
        </h2>
        <button id="closeProjectModal" class="text-gray-400 hover:text-gray-600">
          Close
        </button>
      </div>

      <form id="addProjectForm" method="POST" action="{% url 'add_project' %}">
        {% csrf_token %}

        <div class="space-y-4">
          <!-- Project Name -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Project Name *</label>
            <input type="text" name="project_name" required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>

          <!-- Lead Source (Autocomplete) -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Lead Source *</label>
            <div class="flex items-start gap-2">
              <div class="relative flex-1">
                <input type="text" id="leadSearch" name="lead_source_name" autocomplete="off" required
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Type lead name or phone...">

                <ul id="leadSuggestions"
                  class="absolute bg-white border border-gray-200 w-full mt-1 rounded-lg hidden shadow-lg z-50"></ul>
                <i id="leadStatusIcon"
                  class="fa-solid fa-circle-check text-green-500 hidden absolute right-3 top-3"></i>

                <!-- Hidden field for backend -->
                <input type="hidden" name="lead_source_id" id="leadSourceId">
              </div>

              <!-- ✅ Add New Lead Button -->
              <button type="button" id="openAddLeadModal"
                class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm flex items-center gap-1">
                <i class="fa-solid fa-plus"></i> Add
              </button>
            </div>
          </div>


          <!-- Amount -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Amount</label>
            <input type="number" name="amount" step="0.01"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter project value">
          </div>

          <!-- Expected Closure -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Expected Closure Date</label>
            <input type="date" name="expected_closure"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>

          <!-- Status -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
            <select name="status" required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="open">Open</option>
              <option value="contacted">Contacted</option>
              <option value="boq">BOQ</option>
              <option value="advance">Advance</option>
              <option value="won">Won</option>
              <option value="lost">Lost</option>
            </select>
          </div>

          <!-- Remarks -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Remarks</label>
            <textarea name="remarks" rows="3"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Enter any remarks"></textarea>
          </div>
        </div>

        <div class="flex gap-3 mt-6">
          <button type="button" id="cancelProjectBtn"
            class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
            Cancel
          </button>
          <button type="submit"
            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
            Add Project
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Lead Modal -->
<div id="addLeadModal" class="modal">
  <div class="modal-content max-w-md modal-card">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">Add New Lead</h2>
        <button id="closeAddLeadModal" class="text-gray-400 hover:text-gray-600">✕</button>
      </div>

      <form id="addLeadForm">
        {% csrf_token %}
        <div class="space-y-3">
          <div class="flex gap-2">
            <input type="text" id="newLeadFirstName" placeholder="First Name" required
              class="w-1/2 px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
            <input type="text" id="newLeadLastName" placeholder="Last Name"
              class="w-1/2 px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
          </div>

          <!-- ✅ Country Code & Phone -->
          <div class="flex gap-2">
            <input type="text" id="newLeadCountryCode" placeholder="+91" value="+91" required
              class="w-1/3 px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
            <input type="text" id="newLeadPhone" placeholder="Phone Number" required maxlength="10" pattern="[0-9]{10}"
              class="w-2/3 px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
          </div>

          <input type="text" id="newLeadCity" placeholder="City"
            class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
          <input type="text" id="newLeadAddress" placeholder="Address"
            class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="flex justify-end gap-2 mt-4">
          <button type="button" id="cancelAddLead"
            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">Cancel</button>
          <button type="submit"
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">Save</button>
        </div>
      </form>

    </div>
  </div>
</div>


{% endblock %}
<!-- JavaScript -->
{% block extra_scripts %}
<script>
  const projectModal = document.getElementById('addProjectModal');
  const openProjectBtn = document.getElementById('addProjectBtn');
  const closeProjectBtn = document.getElementById('closeProjectModal');
  const cancelProjectBtn = document.getElementById('cancelProjectBtn');

  openProjectBtn?.addEventListener('click', () => {
    projectModal.classList.add('show');
    document.body.style.overflow = 'hidden';
  });

  [closeProjectBtn, cancelProjectBtn].forEach(btn =>
    btn?.addEventListener('click', () => {
      projectModal.classList.remove('show');
      document.body.style.overflow = 'auto';
      document.getElementById('addProjectForm').reset();
    })
  );

  projectModal?.addEventListener('click', (e) => {
    if (e.target === projectModal) {
      projectModal.classList.remove('show');
      document.body.style.overflow = 'auto';
    }
  });

  // ---- LEAD SOURCE AUTOCOMPLETE ----
  const leadInput = document.getElementById('leadSearch');
  const suggestionsBox = document.getElementById('leadSuggestions');
  const leadStatusIcon = document.getElementById('leadStatusIcon');
  const csrftoken = getCookie('csrftoken');

  function fetchLeadSuggestions(query = '') {
    fetch(`/leads/search/?q=${encodeURIComponent(query)}`, {
      headers: { 'X-CSRFToken': csrftoken }
    })
      .then(res => res.json())
      .then(data => {
        suggestionsBox.innerHTML = '';
        if (data.length === 0) {
          suggestionsBox.classList.add('hidden');
          leadStatusIcon.classList.add('hidden');
        } else {
          suggestionsBox.classList.remove('hidden');
          data.forEach(item => {
            const li = document.createElement('li');
            li.textContent = `${item.first_name} ${item.last_name} (${item.city || ''})`;
            li.className = "px-3 py-2 hover:bg-blue-50 cursor-pointer";
            li.addEventListener('click', () => {
              leadInput.value = `${item.first_name} ${item.last_name}`;
              document.getElementById('leadSourceId').value = item.id;
              suggestionsBox.classList.add('hidden');
              leadStatusIcon.classList.remove('hidden');
              leadInput.dataset.leadId = item.id;
            });
            suggestionsBox.appendChild(li);
          });
        }
      });
  }

  // Show all leads on focus
  leadInput?.addEventListener('focus', function () {
    fetchLeadSuggestions(this.value.trim());
  });

  // Filter leads as user types
  leadInput?.addEventListener('input', function () {
    const query = this.value.trim();
    fetchLeadSuggestions(query);
  });
  // === INLINE AMOUNT EDITING ===
  function editAmount(projectId, currentAmount) {
    document.getElementById(`amount-display-${projectId}`).classList.add('hidden');
    document.getElementById(`amount-edit-${projectId}`).classList.remove('hidden');
    document.getElementById(`amount-input-${projectId}`).focus();
  }

  function cancelEdit(projectId) {
    document.getElementById(`amount-display-${projectId}`).classList.remove('hidden');
    document.getElementById(`amount-edit-${projectId}`).classList.add('hidden');
  }

  function saveAmount(projectId) {
    const newAmount = document.getElementById(`amount-input-${projectId}`).value;
    const csrftoken = getCookie('csrftoken');

    if (!newAmount || parseFloat(newAmount) < 0) {
      alert('Please enter a valid amount');
      return;
    }

    fetch(`/projects/${projectId}/update-amount/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrftoken
      },
      body: `amount=${newAmount}`
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Update display with new formatted amount
          document.getElementById(`amount-display-${projectId}`).textContent = `₹${parseFloat(newAmount).toFixed(2)}`;
          cancelEdit(projectId);
          showToast('Amount updated successfully!', 'success');
        } else {
          showToast(data.message || 'Failed to update amount', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Error updating amount', 'error');
      });
  }
</script>
<script>
  // Django Messages
  {% if messages %}
  {% for message in messages %}
  showToast('{{ message|escapejs }}', '{{ message.tags|default:"success" }}');
  {% endfor %}
  {% endif %}

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function showToast(message, type) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = type === 'error' ? 'toast-error' : 'toast-success';
    toast.classList.remove('hidden');
    toast.classList.add('show');

    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.classList.add('hidden'), 300);
    }, 3000);
  }

  // Update lead status
  function updateStatus(selectElement) {
    const leadId = selectElement.getAttribute('data-lead-id');
    const newStatus = selectElement.value;
    const csrftoken = getCookie('csrftoken');

    // Update visual
    selectElement.className = `status-select status-${newStatus}`;

    fetch('/leads/update-status/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': csrftoken
      },
      body: `lead_id=${leadId}&status=${newStatus}`
    })
      .then(r => r.json())
      .then(data => {
        showToast(data.message || 'Status updated', data.success ? 'success' : 'error');
      })
      .catch(() => showToast('Error updating status', 'error'));
  }

  // Mobile Menu
  document.getElementById('menuToggle')?.addEventListener('click', () => {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('sidebarOverlay').classList.toggle('active');
  });
  document.getElementById('sidebarOverlay')?.addEventListener('click', () => {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('sidebarOverlay').classList.remove('active');
  });

  // Modal
  const modal = document.getElementById('addLeadModal');
  const openBtns = [document.getElementById('newProjectBtn'), document.getElementById('addManualProjectBtn')];
  const closeBtns = [document.getElementById('closeModal'), document.getElementById('cancelBtn')];

  openBtns.forEach(btn => btn?.addEventListener('click', () => {
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
  }));

  closeBtns.forEach(btn => btn?.addEventListener('click', () => {
    modal.classList.remove('show');
    document.body.style.overflow = 'auto';
    document.getElementById('addLeadForm').reset();
  }));

  modal?.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.remove('show');
      document.body.style.overflow = 'auto';
    }
  });

  // Search & Filters
  // === PROJECT SEARCH & FILTERS ===
  // === PROJECT FILTERS ===
  const searchInput = document.getElementById('searchInput');
  const filterCity = document.getElementById('filterCity');
  const filterStatus = document.getElementById('filterStatus');
  const rows = document.querySelectorAll('#projectsTable tbody tr');

  // Collect all unique cities from lead_source.city
  const cities = new Set();
  rows.forEach(row => {
    const city = row.dataset.city?.trim();
    if (city) cities.add(city);
  });

  // Populate city dropdown dynamically
  filterCity.innerHTML = '<option value="">All Cities</option>';
  cities.forEach(city => {
    const option = document.createElement('option');
    option.value = city;
    option.textContent = city;
    filterCity.appendChild(option);
  });

  // Filtering function
  function applyProjectFilters() {
    const query = searchInput ? searchInput.value.toLowerCase() : '';
    const selectedCity = filterCity.value;
    const selectedStatus = filterStatus.value;
    let visibleCount = 0;

    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      const rowCity = row.dataset.city?.trim();
      const rowStatus = row.querySelector('span')?.textContent.toLowerCase();

      const matches =
        (!query || text.includes(query)) &&
        (!selectedCity || rowCity === selectedCity) &&
        (!selectedStatus || rowStatus.includes(selectedStatus));

      row.style.display = matches ? '' : 'none';
      if (matches) visibleCount++;
    });

    document.getElementById('projectCount').textContent = visibleCount;
  }

  // Event listeners
  if (searchInput) searchInput.addEventListener('input', applyProjectFilters);
  filterCity?.addEventListener('change', applyProjectFilters);
  filterStatus?.addEventListener('change', applyProjectFilters);

  // Initial filter
  applyProjectFilters();

  // === ADD LEAD MODAL ===
  const addLeadModal = document.getElementById('addLeadModal');
  const openAddLeadModal = document.getElementById('openAddLeadModal');
  const closeAddLeadModal = document.getElementById('closeAddLeadModal');
  const cancelAddLead = document.getElementById('cancelAddLead');
  const addLeadForm = document.getElementById('addLeadForm');


  function openModal() {
    addLeadModal.classList.add('show');
    document.body.style.overflow = 'hidden';
  }
  function closeModal() {
    addLeadModal.classList.remove('show');
    document.body.style.overflow = 'auto';
    addLeadForm.reset();
  }

  openAddLeadModal?.addEventListener('click', openModal);
  closeAddLeadModal?.addEventListener('click', closeModal);
  cancelAddLead?.addEventListener('click', closeModal);
  addLeadModal?.addEventListener('click', e => {
    if (e.target === addLeadModal) closeModal();
  });

  // === SAVE NEW LEAD ===
  addLeadForm?.addEventListener('submit', e => {
    e.preventDefault();
    const csrftoken = getCookie('csrftoken');

    const payload = {
      first_name: document.getElementById('newLeadFirstName').value,
      last_name: document.getElementById('newLeadLastName').value,
      country_code: document.getElementById('newLeadCountryCode').value || '+91',
      phone_number: document.getElementById('newLeadPhone').value,
      city: document.getElementById('newLeadCity').value,
      address: document.getElementById('newLeadAddress').value,
    };


    fetch('/leads/add-inline/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      },
      body: JSON.stringify(payload)
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // ✅ Fill the main Add Project form
          document.getElementById('leadSearch').value = `${data.first_name} ${data.last_name}`;
          document.getElementById('leadSourceId').value = data.id;

          showToast('Lead added successfully!', 'success');
          closeModal();
        } else {
          showToast(data.message || 'Error adding lead', 'error');
        }
      })
      .catch(() => showToast('Server error while adding lead', 'error'));
  });

  function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = type === 'error' ? 'toast-error' : 'toast-success';
    toast.classList.remove('hidden'); toast.classList.add('show');
    setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.classList.add('hidden'), 300); }, 3000);
  }

  document.getElementById('menuToggle')?.addEventListener('click', () => {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('sidebarOverlay').classList.toggle('active');
  });
  document.getElementById('sidebarOverlay')?.addEventListener('click', () => {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('sidebarOverlay').classList.remove('active');
  });

  document.getElementById('exportBtn')?.addEventListener('click', () => {
    const wb = XLSX.utils.table_to_book(document.getElementById('projectsTable'), { sheet: "Ongoing Projects" });
    const ws = wb.Sheets["Ongoing Projects"];
    ws['!cols'] = [{ wch: 30 }, { wch: 15 }, { wch: 18 }, { wch: 18 }, { wch: 12 }, { wch: 10 }];
    XLSX.writeFile(wb, `Ongoing_Projects_${new Date().toISOString().slice(0, 10)}.xlsx`);
    showToast('Exported successfully!');
  });
  document.querySelectorAll(".sortable").forEach(header => {
    header.addEventListener("click", () => {
      const table = header.closest("table");
      const tbody = table.querySelector("tbody");
      const rows = [...tbody.querySelectorAll("tr")];

      const index = [...header.parentNode.children].indexOf(header);
      const ascending = !header.classList.contains("asc");

      rows.sort((a, b) => {
        let A = a.children[index].innerText.replace(/[₹,]/g, '');
        let B = b.children[index].innerText.replace(/[₹,]/g, '');

        if (!isNaN(A) && !isNaN(B)) {
          return ascending ? A - B : B - A;
        }
        return ascending
          ? A.localeCompare(B)
          : B.localeCompare(A);
      });

      header.classList.toggle("asc", ascending);
      header.classList.toggle("desc", !ascending);

      rows.forEach(row => tbody.appendChild(row));
    });
  });

</script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

{% endblock %}
</body>

</html>