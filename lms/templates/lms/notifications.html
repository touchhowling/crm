{% extends "base.html" %}
{% block title %}Notifications - SecureTech AV CRM{% endblock %}
{% block main %}
<main class="p-8">
  <!-- Breadcrumb -->
  <div class="flex items-center gap-2 text-sm text-gray-500 mb-6">
    <a href="/dashboard/" class="hover:text-blue-600 cursor-pointer">Home</a> /
    <span class="text-gray-900">Notifications</span>
  </div>

  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">Notifications</h1>
      <p class="text-gray-600 mt-1">Stay updated with all your activities</p>
    </div>
    <div class="flex items-center gap-3">
      <a href="{% url 'mark_notifications_read' %}" 
         class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-2">
        <i class="fa-solid fa-check-double"></i>
        Mark All Read
      </a>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-6 border border-blue-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-blue-600 font-medium">Total Notifications</p>
          <p class="text-3xl font-bold text-blue-900 mt-2">{{ notifications|length }}</p>
        </div>
        <div class="w-14 h-14 bg-blue-500 rounded-full flex items-center justify-center">
          <i class="fa-solid fa-bell text-white text-2xl"></i>
        </div>
      </div>
    </div>

    <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-6 border border-orange-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-orange-600 font-medium">Unread</p>
          <p class="text-3xl font-bold text-orange-900 mt-2">{{ unread_count }}</p>
        </div>
        <div class="w-14 h-14 bg-orange-500 rounded-full flex items-center justify-center">
          <i class="fa-solid fa-envelope text-white text-2xl"></i>
        </div>
      </div>
    </div>

    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-6 border border-green-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-green-600 font-medium">Read</p>
          <p class="text-3xl font-bold text-green-900 mt-2">{{ notifications|length|add:"-"|add:unread_count }}</p>
        </div>
        <div class="w-14 h-14 bg-green-500 rounded-full flex items-center justify-center">
          <i class="fa-solid fa-check-circle text-white text-2xl"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter Tabs -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
    <div class="border-b border-gray-200">
      <nav class="flex space-x-8 px-6 tabs-nav" aria-label="Tabs">
        <button class="filter-tab py-4 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600" data-filter="all">
          All <span class="ml-1 bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs">{{ notifications|length }}</span>
        </button>
        <button class="filter-tab py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700" data-filter="unread">
          Unread <span class="ml-1 bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full text-xs">{{ unread_count }}</span>
        </button>
        <button class="filter-tab py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700" data-filter="read">
          Read <span class="ml-1 bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-xs">{{ notifications|length|add:"-"|add:unread_count }}</span>
        </button>
      </nav>
    </div>
  </div>

  <!-- Notifications List -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200">
    {% if notifications %}
    <div id="notificationsList" class="divide-y divide-gray-200">
      {% for notif in notifications %}
      <div class="notification-card p-6 hover:bg-gray-50 transition-colors {% if not notif.is_read %}bg-blue-50{% endif %}" 
           data-read="{% if notif.is_read %}read{% else %}unread{% endif %}">
        <div class="flex items-start gap-4">
          <!-- Icon -->
          <div class="flex-shrink-0">
            <div class="w-12 h-12 rounded-full flex items-center justify-center {% if not notif.is_read %}bg-blue-500{% else %}bg-gray-300{% endif %}">
              <i class="fa-solid fa-bell text-white"></i>
            </div>
          </div>

          <!-- Content -->
          <div class="flex-1 min-w-0">
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1">
                <p class="text-base text-gray-900 leading-relaxed">
                  {{ notif.message }}
                </p>
                <div class="flex items-center gap-4 mt-2">
                  <span class="text-sm text-gray-500 flex items-center gap-1">
                    <i class="fa-regular fa-clock"></i>
                    {{ notif.created_at|date:"M d, Y" }} at {{ notif.created_at|date:"h:i A" }}
                  </span>
                  {% if not notif.is_read %}
                  <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-medium flex items-center gap-1">
                    <i class="fa-solid fa-circle text-blue-500" style="font-size: 6px;"></i>
                    New
                  </span>
                  {% endif %}
                </div>
              </div>

              <!-- Actions -->
              <div class="flex items-center gap-2">
                {% if not notif.is_read %}
                <button class="mark-read-btn text-blue-600 hover:text-blue-700 p-2 rounded-lg hover:bg-blue-100 transition-colors" 
                        data-notif-id="{{ notif.id }}"
                        title="Mark as read">
                  <i class="fa-solid fa-check"></i>
                </button>
                {% endif %}
                <button class="delete-notif-btn text-red-600 hover:text-red-700 p-2 rounded-lg hover:bg-red-100 transition-colors" 
                        data-notif-id="{{ notif.id }}"
                        title="Delete">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="p-12 text-center">
      <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fa-solid fa-inbox text-gray-300 text-5xl"></i>
      </div>
      <h3 class="text-xl font-semibold text-gray-900 mb-2">No Notifications</h3>
      <p class="text-gray-500">You're all caught up! New notifications will appear here.</p>
    </div>
    {% endif %}
  </div>
</main>

<style>
  .notification-card {
    transition: all 0.2s ease;
  }
  
  .notification-card.removing {
    opacity: 0;
    transform: translateX(-20px);
  }

  .filter-tab {
    transition: all 0.2s ease;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Filter tabs
  const filterTabs = document.querySelectorAll('.filter-tab');
  const notificationCards = document.querySelectorAll('.notification-card');

  filterTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const filter = tab.dataset.filter;

      // Update tab styles
      filterTabs.forEach(t => {
        t.classList.remove('border-blue-500', 'text-blue-600');
        t.classList.add('border-transparent', 'text-gray-500');
      });
      tab.classList.remove('border-transparent', 'text-gray-500');
      tab.classList.add('border-blue-500', 'text-blue-600');

      // Filter notifications
      notificationCards.forEach(card => {
        if (filter === 'all') {
          card.style.display = '';
        } else {
          card.style.display = card.dataset.read === filter ? '' : 'none';
        }
      });
    });
  });

  // Mark as read
  document.querySelectorAll('.mark-read-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const notifId = btn.dataset.notifId;
      const card = btn.closest('.notification-card');

      try {
        const response = await fetch(`/notification/${notifId}/read/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          }
        });

        if (response.ok) {
          // Update UI
          card.classList.remove('bg-blue-50');
          card.dataset.read = 'read';
          btn.remove();
          
          // Update badge
          const newBadge = card.querySelector('.bg-blue-100');
          if (newBadge) newBadge.remove();

          showToast('‚úÖ Marked as read', 'success');
          
          // Update counters
          setTimeout(() => location.reload(), 1000);
        }
      } catch (error) {
        console.error('Error:', error);
        showToast('‚ùå Failed to mark as read', 'error');
      }
    });
  });

  // Delete notification
  document.querySelectorAll('.delete-notif-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to delete this notification?')) return;

      const notifId = btn.dataset.notifId;
      const card = btn.closest('.notification-card');

      try {
        const response = await fetch(`/notification/${notifId}/delete/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          }
        });

        if (response.ok) {
          // Animate removal
          card.classList.add('removing');
          setTimeout(() => {
            card.remove();
            
            // Check if list is empty
            const remaining = document.querySelectorAll('.notification-card').length;
            if (remaining === 0) {
              location.reload();
            }
          }, 300);

          showToast('üóëÔ∏è Notification deleted', 'success');
        }
      } catch (error) {
        console.error('Error:', error);
        showToast('‚ùå Failed to delete notification', 'error');
      }
    });
  });

  // Helper functions
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + '=') {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `fixed top-5 right-5 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${
      type === 'success' ? 'bg-green-500' : 'bg-red-500'
    }`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
      toast.style.opacity = '0';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }
});
</script>
{% endblock %}