{% extends "base.html" %}
{% block title %}Lead Details - {{ lead.first_name }} {{ lead.last_name }}{% endblock %}

{% block main %}
<main class="p-8">
  <!-- Breadcrumb -->
  <div class="flex items-center gap-2 text-sm text-gray-500 mb-6">
    <a href="/dashboard/" class="hover:text-blue-600">Home</a> /
    <a href="/leads/" class="hover:text-blue-600">Leads</a> /
    <span class="text-gray-900">{{ lead.first_name }} {{ lead.last_name }}</span>
  </div>

  <!-- Header -->
  <div class="flex justify-between items-start mb-6">
    <div>
      <h1 class="text-3xl font-bold mb-2">{{ project.project_name }}</h1>
      <p class="text-gray-600">{{ lead.country_code }}{{ lead.phone_number }}</p>
    </div>
    <button id="createBOQBtn" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 flex items-center gap-2">
      <i class="fa-solid fa-file-invoice"></i>
      Create BOQ
    </button>
  </div>

  <!-- Lead Info Cards -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <h3 class="font-semibold mb-4 flex items-center gap-2">
        <i class="fa-solid fa-user text-blue-600"></i>
        Contact Information
      </h3>
      <dl class="space-y-3 text-sm">
        <div>
          <dt class="text-gray-500">Phone</dt>
          <dd class="font-medium">{{ lead.country_code }}{{ lead.phone_number }}</dd>
        </div>
        <div>
          <dt class="text-gray-500">City</dt>
          <dd class="font-medium">{{ lead.city|default:"N/A" }}</dd>
        </div>
        <div>
          <dt class="text-gray-500">Address</dt>
          <dd class="font-medium">{{ lead.address|default:"N/A" }}</dd>
        </div>
      </dl>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <h3 class="font-semibold mb-4 flex items-center gap-2">
        <i class="fa-solid fa-info-circle text-green-600"></i>
        Lead Status
      </h3>
      <div class="space-y-3">
        <div>
          <span class="text-sm text-gray-500">Current Status</span>
          <div class="mt-1">
            <span class="px-3 py-1 text-sm font-medium rounded-full 
              {% if project.status == 'won' %}bg-green-100 text-green-700
              {% elif project.status == 'boq' %}bg-purple-100 text-purple-700
              {% elif project.status == 'advanced' %}bg-yellow-100 text-yellow-700
              {% else %}bg-blue-100 text-blue-700{% endif %}">
              {{ project.status }}
            </span>
          </div>
        </div>
        <div>
          <span class="text-sm text-gray-500">Created</span>
          <p class="font-medium">{{ lead.snapshot_d|date:"M d, Y" }}</p>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <h3 class="font-semibold mb-4 flex items-center gap-2">
        <i class="fa-solid fa-sticky-note text-orange-600"></i>
        Remarks
      </h3>
      <p class="text-sm text-gray-600">{{ lead.remarks|default:"No remarks added" }}</p>
    </div>
  </div>

  <!-- BOQ List -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="p-6 border-b">
      <h2 class="text-xl font-bold flex items-center gap-2">
        <i class="fa-solid fa-file-invoice-dollar text-blue-600"></i>
        Bill of Quantities (BOQ)
      </h2>
    </div>
    
    <div id="boqList" class="p-6">
      {% if boqs %}
        <div class="space-y-4">
          {% for boq in boqs %}
            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
              <div class="flex justify-between items-start mb-3">
                <div>
                  <h3 class="font-semibold text-lg">{{ boq.invoice_number }}</h3>
                  <p class="text-sm text-gray-500">Created on {{ boq.created_at|date:"M d, Y" }}</p>
                </div>
                <span class="px-3 py-1 text-xs font-medium rounded-full
                  {% if boq.status == 'approved' %}bg-green-100 text-green-700
                  {% elif boq.status == 'sent' %}bg-blue-100 text-blue-700
                  {% elif boq.status == 'rejected' %}bg-red-100 text-red-700
                  {% else %}bg-gray-100 text-gray-700{% endif %}">
                  {{ boq.get_status_display }}
                </span>
              </div>
              
              <div class="grid grid-cols-4 gap-4 mb-3 text-sm">
                <div>
                  <span class="text-gray-500">Subtotal</span>
                  <p class="font-semibold">₹{{ boq.subtotal|floatformat:2 }}</p>
                </div>
                <div>
                  <span class="text-gray-500">Discount</span>
                  <p class="font-semibold text-red-600">-₹{{ boq.total_discount|floatformat:2 }}</p>
                </div>
                <div>
                  <span class="text-gray-500">Tax ({{ boq.tax_rate }}%)</span>
                  <p class="font-semibold">₹{{ boq.total_tax|floatformat:2 }}</p>
                </div>
                <div>
                  <span class="text-gray-500">Grand Total</span>
                  <p class="font-bold text-lg text-blue-600">₹{{ boq.grand_total|floatformat:2 }}</p>
                </div>
              </div>
              
              <div class="flex gap-2">
                <a href="{% url 'view_boq' boq.id %}" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 flex items-center gap-2">
                  <i class="fa-solid fa-eye"></i> View
                </a>
                <a href="{% url 'download_boq_pdf' boq.id %}" target="_blank" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 flex items-center gap-2">
                  <i class="fa-solid fa-download"></i> Download PDF
                </a>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center py-12">
          <i class="fa-solid fa-file-invoice text-6xl text-gray-300 mb-4"></i>
          <p class="text-gray-500">No BOQs created yet</p>
          <button onclick="document.getElementById('createBOQBtn').click()" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            Create First BOQ
          </button>
        </div>
      {% endif %}
    </div>
  </div>
</main>

<!-- Create BOQ Modal -->
<div id="boqModal" class="modal">
  <div class="modal-content max-w-6xl">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Create Bill of Quantity</h2>
        <button id="closeBOQModal" class="text-gray-400 hover:text-gray-600 text-2xl">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>

      <form id="boqForm" method="POST" action="{% url 'create_boq' lead.id %}">
        {% csrf_token %}

        <!-- Tax & Discount Settings -->
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Tax Rate (%) <span class="text-red-500">*</span>
              </label>
              <input type="number" name="tax_rate" id="taxRate" step="0.01" min="0" max="100" value="18.00" required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
              <p class="text-xs text-gray-500 mt-1">GST applied on discounted price</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Overall Discount (%)</label>
              <input type="number" name="overall_discount_percentage" id="overallDiscountPercentage" step="0.01" min="0" max="100" value="0" 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
              <p class="text-xs text-gray-500 mt-1">Applied on total after item discounts</p>
            </div>
          </div>
        </div>

        <!-- Items Section -->
        <div class="mb-6">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-semibold">Items</h3>
            <button type="button" id="addItemBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 flex items-center gap-2">
              <i class="fa-solid fa-plus"></i> Add Item
            </button>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full text-sm border">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 py-2 text-left border w-16">Sr.No</th>
                  <th class="px-3 py-2 text-left border">Inventory Name</th>
                  <th class="px-3 py-2 text-left border w-32">USP (₹)</th>
                  <th class="px-3 py-2 text-left border w-24">Qty</th>
                  <th class="px-3 py-2 text-left border w-32">Discount (%)</th>
                  <th class="px-3 py-2 text-left border w-32">Line Total</th>
                  <th class="px-3 py-2 text-center border w-20">Action</th>
                </tr>
              </thead>
              <tbody id="itemsTableBody">
                <!-- Items will be added dynamically -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Totals Summary -->
        <div class="bg-blue-50 rounded-lg p-6 mb-6 border border-blue-200">
          <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-sm">
            <div>
              <span class="text-gray-600">Subtotal</span>
              <p id="subtotalDisplay" class="text-lg font-bold">₹0.00</p>
            </div>
            <div>
              <span class="text-gray-600">Item Discounts</span>
              <p id="itemDiscountsDisplay" class="text-lg font-bold text-red-600">-₹0.00</p>
            </div>
            <div>
              <span class="text-gray-600">Overall Discount</span>
              <p id="overallDiscountDisplay" class="text-lg font-bold text-red-600">-₹0.00</p>
            </div>
            <div>
              <span class="text-gray-600">Tax (<span id="taxRateDisplay">18</span>%)</span>
              <p id="taxDisplay" class="text-lg font-bold">₹0.00</p>
            </div>
            <div>
              <span class="text-gray-600">Grand Total</span>
              <p id="grandTotalDisplay" class="text-2xl font-bold text-blue-600">₹0.00</p>
            </div>
          </div>
        </div>

        <!-- Notes -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Notes / Terms & Conditions</label>
          <textarea name="notes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Add any additional notes, payment terms, or special conditions"></textarea>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-3">
          <button type="button" id="cancelBOQBtn" class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
            Cancel
          </button>
          <button type="submit" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
            Save BOQ
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Item Row Template -->
<template id="itemRowTemplate">
  <tr class="item-row border-b">
    <td class="px-3 py-2 border">
      <input type="number" name="sr_no[]" class="sr-no w-full px-2 py-1 border rounded text-center bg-gray-100" readonly>
    </td>
    <td class="px-3 py-2 border">
      <input type="text" name="item_name_display[]" class="item-search w-full px-2 py-1 border rounded" placeholder="Start typing..." autocomplete="off" required>
      <input type="hidden" name="inventory_id[]" class="inventory-id">
      <div class="suggestions-dropdown absolute bg-white border border-gray-300 rounded shadow-lg mt-1 hidden z-50 max-h-48 overflow-y-auto"></div>
      <div class="stock-warning text-xs text-red-600 mt-1 hidden"></div>
    </td>
    <td class="px-3 py-2 border">
      <input type="number" name="unit_price[]" class="unit-price w-full px-2 py-1 border rounded bg-gray-100" step="0.01" readonly>
    </td>
    <td class="px-3 py-2 border">
      <input type="number" name="quantity[]" class="quantity w-full px-2 py-1 border rounded" min="1" value="1" required>
    </td>
    <td class="px-3 py-2 border">
      <input type="number" name="discount[]" class="discount w-full px-2 py-1 border rounded" step="0.01" min="0" max="100" value="0">
    </td>
    <td class="px-3 py-2 border">
      <input type="text" class="line-total w-full px-2 py-1 border rounded bg-gray-100 font-semibold" readonly value="₹0.00">
    </td>
    <td class="px-3 py-2 text-center border">
      <button type="button" class="remove-item text-red-600 hover:text-red-800 text-xl">
        <i class="fa-solid fa-trash"></i>
      </button>
    </td>
  </tr>
</template>

<script>
// Inventory data from backend
const inventoryData = {
  {% for item in inventory_items %}
  {{ item.id }}: {
    id: {{ item.id }},
    name: "{{ item.item_name|escapejs }}",
    price: {{ item.unit_selling_price }},
    availableQty: {{ item.available_quantity }}
  }{% if not forloop.last %},{% endif %}
  {% endfor %}
};

let itemCounter = 0;

// Modal controls
document.getElementById('createBOQBtn').addEventListener('click', () => {
  document.getElementById('boqModal').classList.add('show');
  document.body.style.overflow = 'hidden';
  addNewItem(); // Add first row automatically
});

document.getElementById('closeBOQModal').addEventListener('click', closeBOQModal);
document.getElementById('cancelBOQBtn').addEventListener('click', closeBOQModal);

function closeBOQModal() {
  document.getElementById('boqModal').classList.remove('show');
  document.body.style.overflow = 'auto';
  document.getElementById('boqForm').reset();
  document.getElementById('itemsTableBody').innerHTML = '';
  itemCounter = 0;
}

// Add new item row
document.getElementById('addItemBtn').addEventListener('click', addNewItem);

function addNewItem() {
  const template = document.getElementById('itemRowTemplate');
  const clone = template.content.cloneNode(true);
  const row = clone.querySelector('.item-row');
  
  itemCounter++;
  row.querySelector('.sr-no').value = itemCounter;
  
  document.getElementById('itemsTableBody').appendChild(clone);
  attachItemRowListeners(row);
}

function attachItemRowListeners(row) {
  const itemSearch = row.querySelector('.item-search');
  const suggestionsDropdown = row.querySelector('.suggestions-dropdown');
  const quantity = row.querySelector('.quantity');
  const discount = row.querySelector('.discount');
  const removeBtn = row.querySelector('.remove-item');
  
  // Autocomplete search
  itemSearch.addEventListener('input', function() {
    const query = this.value.toLowerCase().trim();
    
    if (query.length < 2) {
      suggestionsDropdown.classList.add('hidden');
      return;
    }
    
    // Filter inventory
    const matches = Object.values(inventoryData).filter(item => 
      item.name.toLowerCase().includes(query)
    ).slice(0, 10);
    
    if (matches.length > 0) {
      suggestionsDropdown.innerHTML = matches.map(item => `
        <div class="suggestion-item px-4 py-2 hover:bg-blue-50 cursor-pointer flex justify-between" data-item-id="${item.id}">
          <span>${item.name}</span>
          <span class="text-xs text-gray-500">₹${item.price.toFixed(2)} | Stock: ${item.availableQty}</span>
        </div>
      `).join('');
      suggestionsDropdown.classList.remove('hidden');
      
      // Attach click events
      suggestionsDropdown.querySelectorAll('.suggestion-item').forEach(suggestionEl => {
        suggestionEl.addEventListener('click', function() {
          const itemId = this.dataset.itemId;
          selectInventoryItem(row, itemId);
          suggestionsDropdown.classList.add('hidden');
        });
      });
    } else {
      suggestionsDropdown.innerHTML = '<div class="px-4 py-2 text-gray-500 text-sm">No items found</div>';
      suggestionsDropdown.classList.remove('hidden');
    }
  });
  
  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!row.contains(e.target)) {
      suggestionsDropdown.classList.add('hidden');
    }
  });
  
  quantity.addEventListener('input', () => {
    checkStockAndCalculate(row);
  });
  
  discount.addEventListener('input', () => calculateRowTotal(row));
  
  removeBtn.addEventListener('click', () => {
    row.remove();
    renumberRows();
    calculateTotals();
  });
}

function selectInventoryItem(row, itemId) {
  const item = inventoryData[itemId];
  if (!item) return;
  
  row.querySelector('.item-search').value = item.name;
  row.querySelector('.inventory-id').value = item.id;
  row.querySelector('.unit-price').value = item.price.toFixed(2);
  
  checkStockAndCalculate(row);
}

function checkStockAndCalculate(row) {
  const inventoryId = row.querySelector('.inventory-id').value;
  if (!inventoryId) return;
  
  const item = inventoryData[inventoryId];
  const requestedQty = parseInt(row.querySelector('.quantity').value) || 0;
  const warning = row.querySelector('.stock-warning');
  
  if (requestedQty > item.availableQty) {
    warning.textContent = `⚠️ Only ${item.availableQty} units available. Shortage: ${requestedQty - item.availableQty} units`;
    warning.classList.remove('hidden');
    row.classList.add('bg-red-50');
  } else {
    warning.classList.add('hidden');
    row.classList.remove('bg-red-50');
  }
  
  calculateRowTotal(row);
}

function calculateRowTotal(row) {
  const unitPrice = parseFloat(row.querySelector('.unit-price').value) || 0;
  const quantity = parseInt(row.querySelector('.quantity').value) || 0;
  const discountPercent = parseFloat(row.querySelector('.discount').value) || 0;
  
  const gross = unitPrice * quantity;
  const discountAmount = (gross * discountPercent) / 100;
  const lineTotal = gross - discountAmount;
  
  row.querySelector('.line-total').value = '₹' + lineTotal.toFixed(2);
  
  calculateTotals();
}

function renumberRows() {
  const rows = document.querySelectorAll('.item-row');
  rows.forEach((row, index) => {
    row.querySelector('.sr-no').value = index + 1;
  });
  itemCounter = rows.length;
}

function calculateTotals() {
  const rows = document.querySelectorAll('.item-row');
  let subtotal = 0;
  let totalItemDiscounts = 0;
  
  rows.forEach(row => {
    const inventoryId = row.querySelector('.inventory-id').value;
    if (!inventoryId) return;
    
    const unitPrice = parseFloat(row.querySelector('.unit-price').value) || 0;
    const quantity = parseInt(row.querySelector('.quantity').value) || 0;
    const discountPercent = parseFloat(row.querySelector('.discount').value) || 0;
    
    const gross = unitPrice * quantity;
    const discountAmount = (gross * discountPercent) / 100;
    
    subtotal += gross;
    totalItemDiscounts += discountAmount;
  });
  
  const subtotalAfterItemDiscounts = subtotal - totalItemDiscounts;
  
  // Overall discount
  const overallDiscountPercent = parseFloat(document.getElementById('overallDiscountPercentage').value) || 0;
  const overallDiscount = (subtotalAfterItemDiscounts * overallDiscountPercent) / 100;
  
  const amountAfterAllDiscounts = subtotalAfterItemDiscounts - overallDiscount;
  
  // Tax on discounted price
  const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
  const taxAmount = (amountAfterAllDiscounts * taxRate) / 100;
  
  const grandTotal = amountAfterAllDiscounts + taxAmount;
  
  // Update displays
  document.getElementById('subtotalDisplay').textContent = '₹' + subtotal.toFixed(2);
  document.getElementById('itemDiscountsDisplay').textContent = '-₹' + totalItemDiscounts.toFixed(2);
  document.getElementById('overallDiscountDisplay').textContent = '-₹' + overallDiscount.toFixed(2);
  document.getElementById('taxRateDisplay').textContent = taxRate.toFixed(2);
  document.getElementById('taxDisplay').textContent = '₹' + taxAmount.toFixed(2);
  document.getElementById('grandTotalDisplay').textContent = '₹' + grandTotal.toFixed(2);
}

// Recalculate on tax/discount change
document.getElementById('taxRate').addEventListener('input', calculateTotals);
document.getElementById('overallDiscountPercentage').addEventListener('input', calculateTotals);

// Form validation before submit
document.getElementById('boqForm').addEventListener('submit', function(e) {
  const rows = document.querySelectorAll('.item-row');
  
  if (rows.length === 0) {
    e.preventDefault();
    alert('Please add at least one item to the BOQ');
    return false;
  }
  
  let hasEmptyItems = false;
  rows.forEach(row => {
    const inventoryId = row.querySelector('.inventory-id').value;
    if (!inventoryId) {
      hasEmptyItems = true;
    }
  });
  
  if (hasEmptyItems) {
    e.preventDefault();
    alert('Please select inventory items from the dropdown for all rows');
    return false;
  }
  
  return true;
});
</script>

<style>
.suggestions-dropdown {
  max-width: 400px;
  width: 100%;
}

.suggestion-item:last-child {
  border-bottom: none;
}

.modal {
  display: none;
  position: fixed;
  z-index: 50;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.5);
}

.modal.show {
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background-color: white;
  border-radius: 1rem;
  width: 90%;
  max-width: 1200px;
  max-height: 90vh;
  overflow-y: auto;
}
</style>
{% endblock %}