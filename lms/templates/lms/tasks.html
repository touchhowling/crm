{% extends "base.html" %}
{% block title %}Tasks - SecureTech AV CRM{% endblock %}
{% block main %}
    <!-- Main Content -->
    <main class="p-8">
        <!-- Flash Messages -->
      {% if messages %}
        <div id="flashMessages" class="mb-4 space-y-2">
          {% for message in messages %}
            <div 
              class="flash-message flex items-center justify-between px-4 py-3 rounded-lg shadow-sm animate-slide-in
              {% if message.tags == 'success' %}
                bg-green-50 border border-green-200 text-green-700
              {% elif message.tags == 'error' %}
                bg-red-50 border border-red-200 text-red-700
              {% elif message.tags == 'warning' %}
                bg-yellow-50 border border-yellow-200 text-yellow-700
              {% else %}
                bg-blue-50 border border-blue-200 text-blue-700
              {% endif %}">
              <div class="flex items-center gap-2">
                {% if message.tags == 'success' %}
                  <i class="fa-solid fa-circle-check"></i>
                {% elif message.tags == 'error' %}
                  <i class="fa-solid fa-circle-xmark"></i>
                {% elif message.tags == 'warning' %}
                  <i class="fa-solid fa-triangle-exclamation"></i>
                {% else %}
                  <i class="fa-solid fa-info-circle"></i>
                {% endif %}
                <span class="text-sm font-medium">{{ message }}</span>
              </div>
              <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
          {% endfor %}
        </div>
      {% endif %}

    <div class="flex items-center gap-2 text-sm text-gray-500 mb-6">
      <span class="hover:text-blue-600 cursor-pointer">Home</span> /
      <span class="text-gray-900">Tasks</span>
    </div>

    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">Task Management</h1>
      {% if is_admin or is_task_role %}
        <button id="newTaskBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 flex items-center gap-2 transition-all">
          <i class="fa-solid fa-plus"></i> New Task
        </button>
      {% endif %}
    </div>

    <!-- Tabs -->
    <div class="border-b border-gray-200 mb-6">
      <nav class="-mb-px flex space-x-8" aria-label="Tabs">
        <button class="tab-btn text-gray-500 py-4 px-1 border-b-2 font-medium text-sm transition-colors" data-tab="active">
          Active <span class="ml-1 bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs">{{ active_tasks|length }}</span>
        </button>
        <button class="tab-btn text-gray-500 py-4 px-1 border-b-2 font-medium text-sm transition-colors" data-tab="completed">
          Completed <span class="ml-1 bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-xs">{{ completed_tasks|length }}</span>
        </button>
        <button class="tab-btn text-gray-500 py-4 px-1 border-b-2 font-medium text-sm transition-colors" data-tab="pending">
          Pending <span class="ml-1 bg-red-100 text-red-700 px-2 py-0.5 rounded-full text-xs">{{ pending_tasks|length }}</span>
        </button>
      </nav>
    </div>

    <!-- Active Tasks Table -->
    <div id="active" class="tab-content">
      {% include "lms/tasks_table.html" with task_list=active_tasks title="Active Tasks" %}
    </div>

    <!-- Completed Tasks Table -->
    <div id="completed" class="tab-content hidden">
      {% include "lms/tasks_table.html" with task_list=completed_tasks title="Completed Tasks" %}
    </div>

    <!-- Pending Tasks Table -->
    <div id="pending" class="tab-content hidden">
      {% include "lms/tasks_table.html" with task_list=pending_tasks title="Pending Tasks" %}
    </div>
    
  </main>

  </div>

  <!-- View Task Details Modal -->
  <div id="viewTaskModal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold flex items-center gap-2">
          <i class="fa-solid fa-eye text-blue-500"></i>
          <span id="viewTaskTitle">Task Details</span>
        </h2>
        <button id="closeViewModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      
      <div class="space-y-4">
        <!-- Priority Badge -->
        <div class="flex items-center gap-2">
          <span class="text-sm font-medium text-gray-700">Priority:</span>
          <span id="viewTaskPriority" class="px-3 py-1 rounded-full text-xs font-semibold"></span>
        </div>

        <!-- Description -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
          <div id="viewTaskDescription" class="p-4 bg-gray-50 rounded-lg text-gray-800 min-h-[100px] whitespace-pre-wrap"></div>
        </div>

        <!-- Project -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Project</label>
          <div id="viewTaskProject" class="p-3 bg-blue-50 rounded-lg text-blue-800 font-medium"></div>
        </div>

        <!-- Assigned To -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Assigned To</label>
          <div id="viewTaskAssignee" class="p-3 bg-purple-50 rounded-lg text-purple-800 font-medium flex items-center gap-2">
            <i class="fa-solid fa-user"></i>
            <span></span>
          </div>
        </div>

        <!-- Assigned By -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Assigned By</label>
          <div id="viewTaskAssigner" class="p-3 bg-purple-50 rounded-lg text-purple-800 font-medium flex items-center gap-2">
            <i class="fa-solid fa-user"></i>
            <span></span>
          </div>
        </div>

        <!-- Due Date -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
          <div id="viewTaskDueDate" class="p-3 bg-orange-50 rounded-lg text-orange-800 font-medium flex items-center gap-2">
            <i class="fa-solid fa-calendar"></i>
            <span></span>
          </div>
        </div>

        <!-- Status -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
          <div id="viewTaskStatus" class="p-3 rounded-lg font-medium flex items-center gap-2">
            <i class="fa-solid fa-circle-check"></i>
            <span></span>
          </div>
        </div>
      </div>

      <div class="mt-6 flex justify-end gap-2">
        <button type="button" id="closeViewBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
          Close
        </button>
        {% if is_admin %}
        <button type="button" id="editFromViewBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-2">
          <i class="fa-solid fa-edit"></i>
          Edit Task
        </button>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- New Task Modal -->
  <div id="newTaskModal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">New Task</h2>
        <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      <form id="newTaskForm" method="POST" action="{% url 'add_task' %}">
        {% csrf_token %}
        <div class="space-y-4">
          <div>
            <label for="taskTitle" class="block text-sm font-medium text-gray-700">Title</label>
            <input type="text" id="taskTitle" name="title" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div>
            <label for="taskDescription" class="block text-sm font-medium text-gray-700">Description</label>
            <textarea id="taskDescription" name="description" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
          </div>
          <div>
            <label for="taskProject" class="block text-sm font-medium text-gray-700">Project</label>
            <select id="taskProject" name="project" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
              <option value="">Select Project</option>
              {% for project in projects %}
              <option value="{{ project.id }}">{{ project.project_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="taskAssignee" class="block text-sm font-medium text-gray-700">Assign To</label>
            <select id="taskAssignee" name="user" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
              <option value="">Select User</option>
              {% for user in users %}
              <option value="{{ user.id }}">{{ user.username }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="taskPriority" class="block text-sm font-medium text-gray-700">Priority</label>
            <select id="taskPriority" name="priority" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
              <option value="High">High</option>
              <option value="Medium" selected>Medium</option>
              <option value="Low">Low</option>
            </select>
          </div>
          <div>
            <label for="taskDueDate" class="block text-sm font-medium text-gray-700">Due Date</label>
            <input type="datetime-local" id="taskDueDate" name="due_date" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>
        </div>
        <div class="mt-6 flex justify-end">
          <button type="button" id="cancelBtn" class="mr-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
            Create Task
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Task Modal -->
  <div id="editTaskModal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">Edit Task</h2>
        <button id="closeEditModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      <form id="editTaskForm" method="POST">
        {% csrf_token %}
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Title</label>
            <input type="text" id="editTaskTitle" name="title" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Description</label>
            <textarea id="editTaskDescription" name="description" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Priority</label>
            <select id="editTaskPriority" name="priority" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
              <option value="High">High</option>
              <option value="Medium">Medium</option>
              <option value="Low">Low</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Due Date</label>
            <input type="datetime-local" id="editTaskDueDate" name="due_date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>
        </div>
        <div class="mt-6 flex justify-end">
          <button type="button" id="cancelEditBtn" class="mr-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
            Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>

  <style>
    @keyframes slide-in {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-slide-in {
      animation: slide-in 0.3s ease-out;
    }

    .flash-message {
      transition: all 0.3s ease;
    }
  </style>

  <script>
    // Auto-hide flash messages after 3 seconds
    document.addEventListener('DOMContentLoaded', () => {
      const flashMessages = document.querySelectorAll('.flash-message');
      flashMessages.forEach((msg) => {
        setTimeout(() => {
          msg.style.opacity = '0';
          msg.style.transform = 'translateX(100%)';
          setTimeout(() => msg.remove(), 300);
        }, 3000);
      });

      // New Task Modal
      const newTaskBtn = document.getElementById('newTaskBtn');
      const newTaskModal = document.getElementById('newTaskModal');
      const closeModalBtn = document.getElementById('closeModalBtn');
      const cancelBtn = document.getElementById('cancelBtn');

      if (newTaskBtn) {
        newTaskBtn.addEventListener('click', () => {
          newTaskModal.classList.remove('hidden');
        });
      }

      if (closeModalBtn) {
        closeModalBtn.addEventListener('click', () => {
          newTaskModal.classList.add('hidden');
        });
      }

      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
          newTaskModal.classList.add('hidden');
        });
      }

      // View Task Modal
      const viewTaskModal = document.getElementById('viewTaskModal');
      const closeViewModalBtn = document.getElementById('closeViewModalBtn');
      const closeViewBtn = document.getElementById('closeViewBtn');

      // Attach click handlers to all task rows
      document.querySelectorAll('.view-task-row').forEach((row) => {
        row.addEventListener('click', async (e) => {
          // Don't trigger if clicking checkbox or action buttons
          if (e.target.closest('.mark-complete') || e.target.closest('.edit-task') || e.target.closest('.delete-task')) {
            return;
          }

          const taskId = row.dataset.taskId;
          const taskData = {
            title: row.dataset.taskTitle,
            description: row.dataset.taskDescription || 'No description provided',
            priority: row.dataset.taskPriority,
            project: row.dataset.taskProject,
            assignee: row.dataset.taskAssignee,
            assigner: row.dataset.taskAssigner,
            dueDate: row.dataset.taskDueDate,
            completed: row.dataset.taskCompleted === 'True'
          };

          // Populate modal
          document.getElementById('viewTaskTitle').textContent = taskData.title;
          document.getElementById('viewTaskDescription').textContent = taskData.description;
          document.getElementById('viewTaskProject').textContent = taskData.project;
          document.getElementById('viewTaskAssignee').querySelector('span').textContent = taskData.assignee;
          document.getElementById('viewTaskAssigner').querySelector('span').textContent = taskData.assigner;
          document.getElementById('viewTaskDueDate').querySelector('span').textContent = new Date(taskData.dueDate).toLocaleString();

          // Priority styling
          const priorityBadge = document.getElementById('viewTaskPriority');
          priorityBadge.textContent = taskData.priority;
          priorityBadge.className = 'px-3 py-1 rounded-full text-xs font-semibold ';
          if (taskData.priority === 'High') {
            priorityBadge.className += 'bg-red-100 text-red-700';
          } else if (taskData.priority === 'Medium') {
            priorityBadge.className += 'bg-yellow-100 text-yellow-700';
          } else {
            priorityBadge.className += 'bg-green-100 text-green-700';
          }

          // Status styling
          const statusDiv = document.getElementById('viewTaskStatus');
          if (taskData.completed) {
            statusDiv.className = 'p-3 rounded-lg font-medium flex items-center gap-2 bg-green-50 text-green-700';
            statusDiv.querySelector('span').textContent = 'Completed';
          } else {
            statusDiv.className = 'p-3 rounded-lg font-medium flex items-center gap-2 bg-orange-50 text-orange-700';
            statusDiv.querySelector('span').textContent = 'In Progress';
          }

          // Store task ID for edit button
          document.getElementById('editFromViewBtn').dataset.taskId = taskId;

          viewTaskModal.classList.remove('hidden');
        });
      });

      closeViewModalBtn.addEventListener('click', () => {
        viewTaskModal.classList.add('hidden');
      });

      closeViewBtn.addEventListener('click', () => {
        viewTaskModal.classList.add('hidden');
      });

      // Edit from view modal
      const editFromViewBtn = document.getElementById('editFromViewBtn');
      if (editFromViewBtn) {
        editFromViewBtn.addEventListener('click', async () => {
          const taskId = editFromViewBtn.dataset.taskId;
          viewTaskModal.classList.add('hidden');
          
          // Open edit modal with task data
          const response = await fetch(`/task/${taskId}/`);
          const data = await response.json();

          document.getElementById('editTaskTitle').value = data.title;
          document.getElementById('editTaskDescription').value = data.description;
          document.getElementById('editTaskDueDate').value = data.due_date;
          document.getElementById('editTaskPriority').value = data.priority;
          document.getElementById('editTaskForm').action = `/task/${taskId}/edit/`;

          document.getElementById('editTaskModal').classList.remove('hidden');
        });
      }
    });
  </script>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const editModal = document.getElementById("editTaskModal");
  const closeEditModalBtn = document.getElementById("closeEditModalBtn");
  const cancelEditBtn = document.getElementById("cancelEditBtn");
  const editForm = document.getElementById("editTaskForm");

  closeEditModalBtn.addEventListener("click", () => editModal.classList.add("hidden"));
  cancelEditBtn.addEventListener("click", () => editModal.classList.add("hidden"));

  document.querySelectorAll("a.edit-task").forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      e.preventDefault();
      e.stopPropagation();
      const taskId = btn.dataset.taskId;

      const response = await fetch(`/task/${taskId}/`);
      const data = await response.json();

      document.getElementById("editTaskTitle").value = data.title;
      document.getElementById("editTaskDescription").value = data.description;
      document.getElementById("editTaskDueDate").value = data.due_date;
      document.getElementById("editTaskPriority").value = data.priority;
      editForm.action = `/task/${taskId}/edit/`;

      editModal.classList.remove("hidden");
    });
  });

  // Handle form submission with reload
  editForm.addEventListener('submit', (e) => {
    setTimeout(() => window.location.reload(), 1000);
  });

  const newTaskForm = document.getElementById('newTaskForm');
  if (newTaskForm) {
    newTaskForm.addEventListener('submit', (e) => {
      setTimeout(() => window.location.reload(), 1000);
    });
  }
});
</script>
{% endblock %}