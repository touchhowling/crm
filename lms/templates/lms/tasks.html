{% extends "base.html" %}
{% block main %}
    <!-- Main Content -->
    <main class="p-8">
        <!-- Flash Messages -->
      {% if messages %}
        <div class="mb-4 space-y-2">
          {% for message in messages %}
            <div 
              class="flex items-center justify-between px-4 py-3 rounded-lg shadow-sm
              {% if message.tags == 'success' %}
                bg-green-50 border border-green-200 text-green-700
              {% elif message.tags == 'error' %}
                bg-red-50 border border-red-200 text-red-700
              {% elif message.tags == 'warning' %}
                bg-yellow-50 border border-yellow-200 text-yellow-700
              {% else %}
                bg-blue-50 border border-blue-200 text-blue-700
              {% endif %}">
              <div class="flex items-center gap-2">
                {% if message.tags == 'success' %}
                  <i class="fa-solid fa-circle-check"></i>
                {% elif message.tags == 'error' %}
                  <i class="fa-solid fa-circle-xmark"></i>
                {% elif message.tags == 'warning' %}
                  <i class="fa-solid fa-triangle-exclamation"></i>
                {% else %}
                  <i class="fa-solid fa-info-circle"></i>
                {% endif %}
                <span class="text-sm font-medium">{{ message }}</span>
              </div>
              <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
          {% endfor %}
        </div>
      {% endif %}

    <div class="flex items-center gap-2 text-sm text-gray-500 mb-6">
      <span class="hover:text-blue-600 cursor-pointer">Home</span> /
      <span class="text-gray-900">Tasks</span>
    </div>

    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">Task Management</h1>
      {% if is_admin %}
        <button id="newTaskBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 flex items-center gap-2">
          <i class="fa-solid fa-plus"></i> New Task
        </button>
      {% endif %}
    </div>

    <!-- Tabs -->
    <div class="border-b border-gray-200 mb-6">
      <nav class="-mb-px flex space-x-8" aria-label="Tabs">
        <button class="tab-btn text-gray-500 py-4 px-1 border-b-2 font-medium text-sm" data-tab="active">
          Active <span class="ml-1 bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs">{{ active_tasks|length }}</span>
        </button>
        <button class="tab-btn text-gray-500 py-4 px-1 border-b-2 font-medium text-sm" data-tab="completed">
          Completed <span class="ml-1 bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-xs">{{ completed_tasks|length }}</span>
        </button>
        <button class="tab-btn text-gray-500 py-4 px-1 border-b-2 font-medium text-sm" data-tab="pending">
          Pending <span class="ml-1 bg-red-100 text-red-700 px-2 py-0.5 rounded-full text-xs">{{ pending_tasks|length }}</span>
        </button>
      </nav>
    </div>

    <!-- Active Tasks Table -->
    <div id="active" class="tab-content">
      {% include "lms/tasks_table.html" with task_list=active_tasks title="Active Tasks" %}
    </div>

    <!-- Completed Tasks Table -->
    <div id="completed" class="tab-content hidden">
      {% include "lms/tasks_table.html" with task_list=completed_tasks title="Completed Tasks" %}
    </div>

    <!-- Pending Tasks Table -->
    <div id="pending" class="tab-content hidden">
      {% include "lms/tasks_table.html" with task_list=pending_tasks title="Pending Tasks" %}
    </div>
  </main>

  </div>

  <!-- New Task Modal -->
  <div id="newTaskModal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">New Task</h2>
        <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">&times;</button>
      </div>
      <form id="newTaskForm" method="POST" action="{% url 'add_task' %}">
        {% csrf_token %}
        <div class="space-y-4">
          <div>
            <label for="taskTitle" class="block text-sm font-medium text-gray-700">Title</label>
            <input type="text" id="taskTitle" name="title" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div>
            <label for="taskDescription" class="block text-sm font-medium text-gray-700">Description</label>
            <textarea id="taskDescription" name="description" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
          </div>
          <div>
            <label for="taskProject" class="block text-sm font-medium text-gray-700">Project</label>
            <select id="taskProject" name="project" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
              <option value="">Select Project</option>
              {% for project in projects %}
              <option value="{{ project.id }}">{{ project.project_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="taskAssignee" class="block text-sm font-medium text-gray-700">Assign To</label>
            <select id="taskAssignee" name="user" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
              <option value="">Select User</option>
              {% for user in users %}
              <option value="{{ user.id }}">{{ user.username }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="taskPriority" class="block text-sm font-medium text-gray-700">Priority</label>
            <select id="taskPriority" name="priority" required
                    class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
              <option value="High">High</option>
              <option value="Medium" selected>Medium</option>
              <option value="Low">Low</option>
            </select>
          </div>
          <div>
            <label for="taskDueDate" class="block text-sm font-medium text-gray-700">Due Date</label>
            <input type="datetime-local" id="taskDueDate" name="due_date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          </div>
        </div>
        <div class="mt-6 flex justify-end">
          <button type="button" id="cancelBtn" class="mr-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
<button
  type="submit"
  class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
  onclick="setTimeout(() => window.location.reload(), 1500)"
>
  Create Task
</button>        </div>
      </form>
    </div>
  </div>
  <!-- Edit Task Modal -->
<div id="editTaskModal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold">Edit Task</h2>
      <button id="closeEditModalBtn" class="text-gray-500 hover:text-gray-700">&times;</button>
    </div>
    <form id="editTaskForm" method="POST">
      {% csrf_token %}
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Title</label>
          <input type="text" id="editTaskTitle" name="title"
                 class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Description</label>
          <textarea id="editTaskDescription" name="description" rows="3"
                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
        </div>
        <div>
        <label class="block text-sm font-medium text-gray-700">Priority</label>
        <select id="editTaskPriority" name="priority" required
                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
          <option value="High">High</option>
          <option value="Medium">Medium</option>
          <option value="Low">Low</option>
        </select>
      </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Due Date</label>
          <input type="datetime-local" id="editTaskDueDate" name="due_date"
                 class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
        </div>
      </div>
      <div class="mt-6 flex justify-end">
        <button type="button" id="cancelEditBtn"
                class="mr-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
          Cancel
        </button>
        <button type="submit"
                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
          Save Changes
        </button>
      </div>
    </form>
  </div>
</div>


  <script>
    document.getElementById('newTaskBtn').addEventListener('click', () => {
      document.getElementById('newTaskModal').classList.remove('hidden');
    });

    document.getElementById('closeModalBtn').addEventListener('click', () => {
      document.getElementById('newTaskModal').classList.add('hidden');
    });

    document.getElementById('cancelBtn').addEventListener('click', () => {
      document.getElementById('newTaskModal').classList.add('hidden');
    });
  </script>
{% endblock %}


{%block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const editModal = document.getElementById("editTaskModal");
  const closeEditModalBtn = document.getElementById("closeEditModalBtn");
  const cancelEditBtn = document.getElementById("cancelEditBtn");
  const editForm = document.getElementById("editTaskForm");

  // Close modal
  closeEditModalBtn.addEventListener("click", () => editModal.classList.add("hidden"));
  cancelEditBtn.addEventListener("click", () => editModal.classList.add("hidden"));

  // Attach to each edit button
  document.querySelectorAll("a.edit-task").forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      e.preventDefault();
      const taskId = btn.dataset.taskId;

      // Fetch task data from backend
      const response = await fetch(`/task/${taskId}/`);
      const data = await response.json();

      // Fill the modal inputs
      document.getElementById("editTaskTitle").value = data.title;
      document.getElementById("editTaskDescription").value = data.description;
      document.getElementById("editTaskDueDate").value = data.due_date;
      document.getElementById("editTaskPriority").value = data.priority;
      // Set form action dynamically
      editForm.action = `/task/${taskId}/edit/`;

      // Show modal
      editModal.classList.remove("hidden");
    });
  });
});
</script>
{% endblock %}

